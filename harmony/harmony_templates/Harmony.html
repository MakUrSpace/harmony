<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="/bootstrap.min.css">
    <script src="/bootstrap.min.js"></script>
    <script src="/htmx.min.js"></script>

    <style>
        table, th, td {
          border: 1px solid black;
          padding: 15px;
        }
        
        .x-box {
            position: relative;
            display: flex;
        }

        .x-box::before,
        .x-box::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; /* Ensures it appears over text */
            pointer-events: none; /* Allows interactions with underlying content */
        }

        .x-box::before {
            background: linear-gradient(30deg, transparent 49%, red 49%, red 51%, transparent 51%);
        }

        .x-box::after {
            background: linear-gradient(-30deg, transparent 49%, red 49%, red 51%, transparent 51%);
        }
    </style>
    
    <title>Harmony</title>
</head>
<body>
<div class="container">
    <h1 align="center">Harmony</h1>
    <hr>
    <div class="row" style="min-width: 500px">
        <div class="container justify-content-center" align="center">
            <h3 id="GameWorldHeader">Game World View -- {defaultCamera}</h3>
            <form id="selectPixelForm" hx-post="{harmonyURL}select_pixel" hx-target="#interactor">
                <input type="hidden" name="selectedCamera" id="selectedCamera" value="{defaultCamera}">
                <input type="hidden" name="selectedPixel" id="selectedPixel" value="">
                <input type="hidden" name="appendPixel" id="appendPixel" value="false">
                <input type="hidden" name="viewId" id="viewId" value="{viewId}">
            </form>
            <div id="GameWorldViewer">
                <img id="GameWorld" class="img-responsive border border-3 border-info bg-primary" src="{harmonyURL}camWithChanges/{defaultCamera}/{viewId}" style="border-radius: 40px; max-width: 90%;" onclick="imageClickListener(event)">
            </div>
            <script>
                function imageClickListener(event) {
                    console.log("Image clicked!!", event)
                    const imgElem = document.getElementById(`GameWorld`)
                    const bounds=imgElem.getBoundingClientRect();
                    console.log("img element bounds: ", bounds)
                    const left=bounds.left;
                    const top=bounds.top;
                    const x = event.x - left;
                    const y = event.y - top;
                    const cw=imgElem.clientWidth
                    const ch=imgElem.clientHeight
                    
                    const selectedCamera = document.getElementById(`selectedCamera`).value
                    var natural_width = 1920
                    var natural_height = 1080
                    if (selectedCamera === "VirtualMap") {
                        natural_width = 1200
                        natural_height = 1200
                    }
                    const px=x/cw*natural_width
                    const py=y/ch*natural_height
                    const x_offset = 0
                    const x_scale = 1
                    const image_x = (px - x_offset) * x_scale
                    const y_offset = 0
                    const y_scale = 1
                    const image_y = (py - y_offset) * y_scale
                    const pixelField = document.getElementById(`selectedPixel`)
                    const selectPixelForm = document.getElementById(`selectPixelForm`)
                    pixelField.value = JSON.stringify([~~image_x, ~~image_y])
                    selectPixelForm.requestSubmit()
                }
                
                function gameWorldClick(camNum){
                    const view_id = document.getElementById(`viewId`).value
                    var header = document.querySelector("#GameWorldHeader")
                    header.innerText = `Game World View -- ${camNum}`
                    var img = document.querySelector("#GameWorld")
                    img.src = `{harmonyURL}/camWithChanges/${camNum}/${view_id}`
                    const camField = document.getElementById(`selectedCamera`)
                    camField.value = camNum
                }
            </script>
        </div>
        <div class="container justify-content-center" align="center">
            {cameraButtons}
        </div>
    	<div class="row justify-content-center" align="center" style="min-width: 500px">
            <div id="interactor" class="row"></div>
            <hr>
            <div id="objectTable" class="row">
                <div id="objectFilterRetriever" hx-get="{harmonyURL}objects" hx-trigger="every 1s" hx-target="#objectFilterRetriever"></div>
            </div>
            <div class="row">
                <div class="col" align="left">
                    <form hx-post="{harmonyURL}save" hx-swap="none">
                        <input class="btn btn-success" type="submit" value="Save Game">
                        <input class="text" value="Harmony" id="game_name" name="game_name">
                    </form>
                </div>
                <div class="col" align="right">
                    <input class="btn btn-info" type="button" value="Configurator" onclick="window.location.href='{configuratorURL}'">
                </div>
            </div>
            <div class="row">
                <div class="col" align="left">
                    <input class="btn btn-warning" type="submit" value="Load Game" onclick="loadGame()">
                    <form id="load_game" hx-post="{harmonyURL}load" hx-swap="none">
                        <input type="hidden" value="Harmony" id="load_game_name" name="game_name">
                    </form>
                    <script>
                        function load_game(){
                            const gameName = document.getElementById(`game_name`).value
                            const loadGameField = document.getElementById(`load_game_name`)
                            loadGameField.value = game_name
                            const loadGameForm = document.getElementById(`load_game`)
                            loadGameForm.requestSubmit()
                        }
                    </script>
                </div>
                <div class="col" align="right">
                    <input class="btn btn-danger" type="button" value="Reset Game" hx-get="{harmonyURL}reset">
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
